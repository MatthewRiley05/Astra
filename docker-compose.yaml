services:
  # Open WebUI Service
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    restart: unless-stopped
    ports:
      - "3000:8080"
    environment:
      OPENAI_API_KEY: ${DEEPSEEK_API_KEY}
      OPENAI_API_BASE_URL: https://api.deepseek.com/v1
    volumes:
      - open-webui-data:/app/backend/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  # Piper TTS Service
  tts:
    build:
      context: ./tts
      dockerfile: dockerfile
    container_name: piper-tts
    restart: unless-stopped
    ports:
      - "5500:5500"
    environment:
      PIPER_VOICES: en_US-amy-medium
    volumes:
      - piper-voices:/voices
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5500/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M

  # Sentiment Analyzer Service
  sentiment-analyzer:
    build:
      context: ./sentiment
      dockerfile: dockerfile
    container_name: sentiment-analyzer
    restart: unless-stopped
    ports:
      - "5501:5501"
    environment:
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5501/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M

  # Email Scheduler Service
  email-scheduler:
    build:
      context: ./email
      dockerfile: dockerfile
    container_name: email-scheduler
    restart: unless-stopped
    ports:
      - "5502:5502"
    environment:
      GMAIL_CREDENTIALS: ${GMAIL_CREDENTIALS}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5502/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

  # Financial Data Service
  financial-data:
    build:
      context: ./finance
      dockerfile: dockerfile
    container_name: financial-data
    restart: unless-stopped
    ports:
      - "5503:5503"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5503/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M

  # Market Data Service
  market-data:
    build:
      context: ./market_data
      dockerfile: dockerfile
    container_name: market-data
    restart: unless-stopped
    ports:
      - "5003:5003"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5003/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

volumes:
  open-webui-data:
    driver: local
  piper-voices:
    driver: local

networks:
  default:
    name: astra-network
